app.controller('HomePageCtrl', ['$scope', '$http', '$location', '$auth', '$routeParams', '$sce', '$modal', '$window', function($scope, $http, $location, $auth, $routeParams, $sce, $modal, $window){

  var url = "<%= ENV['URL'] %>" || "https://localhost:3000";




  // BY DEFAULT HIDE ALL CARDS
  $scope.positionBg = true;
  $scope.ttechBg = false;
  $scope.showTechTypes = false;
  $scope.techSelected = false;
  // DISABLE INPUT BOX UNLESS POSITION IS SELECTED
  $scope.techTypeInput = false;


  // DISABLE SELECT BOX UNLESS TECHNIQUE IS SELECTED
  $scope.proficiencySelect = false;

  // BOOTSTRAP TOOLTIP PLUGIN
  $(function () {
    $('[data-toggle="tooltip"]').tooltip()
  });

  //Reorganise the fields array by index
  var compare = function(a,b) {
    if (a.index < b.index)
      return -1;
    if (a.index > b.index)
      return 1;
    return 0;
  }
  // ============= POSITION ============== //

  // SHOW ALL POSITIONS
  $scope.positions = [];
  $http.get(url + '/positions').success(function(response){
    $scope.positions = response.sort(compare);
    $scope.positions.sort(compare);
    console.log($scope.positions);
  });

  // CREATE NEW POSITION
  $scope.newPosition = {};
  $scope.positionForm = {};


  $scope.positionForm.create = function(){
    var data = {
      index: ($scope.positions.length),
      name: $scope.newPosition.name      
    };
        console.log($scope.newPosition);
        console.log($scope.newIndex);
        console.log(data);


    $http.post(url + '/positions', data).success(function(response){
      console.log(response);      

      $http.get(url + '/positions').success(function(response){
      $scope.positions = response.sort(compare);
      $scope.positions.sort(compare);
      console.log($scope.positions);
      });
    });
    $scope.newPosition = null; 
  };

  // DELETE A POSITION
  $scope.delete = function(position){
    var pos_to_delete = $scope.positions.indexOf(position);

    $http.delete(url + '/positions/' + position.id).success(function(response){
      $scope.positions.splice(pos_to_delete, 1);
      $scope.positionBg = true;
      $scope.ttechBg = false;
      $scope.showTechTypes = false;
      $scope.techTypeInput = false;
      $scope.currentPositionName = null;
      $scope.currentPositionName = null;
      $scope.techTypeInput = false;  
      console.log($scope.positions.length)
      $scope.positionSave(); 
    });
  };

// =========== TECHNIQUE TYPE ============ //

  // SHOW TECHNIQUE TYPES & TECHNIQUES
  $scope.technique_types = [];
  $scope.currentPosition = [];
  $scope.currentPostionName = [];
  $scope.currentPositionFull = [];
  $scope.getPosition = function(position){
    console.log(position.id);

    $scope.proficiencySelect = false;

    if (window.innerWidth <= 1024) {
      $scope.navToggle()
      $scope.arrow = false;
    }

    $scope.currentPositionFull = position;
    $scope.currentPosition = position.id;
    $scope.currentPositionName = position.name;
    $scope.technique_types.sort(compare);
    $scope.newTechType = null;

    $http.get(url + '/positions/' + $scope.currentPosition + '/technique_types').success(function(response){
      $scope.technique_types = response.sort(compare);

      for (var i = 0; i < $scope.technique_types.length; i++) {
        $scope.technique_types[i].techniques.sort(compare);
      }
      console.log(response);
      console.log($scope.techniques);
      // SHOW INPUT BOX
      $scope.techTypeInput = true;

      // HIDE STARTING BACKGROUND
      if ($scope.technique_types.length < 1) {
        $scope.positionBg = false;
        $scope.ttechBg = true;
        $scope.showTechTypes = false;
      } else {
        $scope.positionBg = false;
        $scope.ttechBg = false;
        $scope.showTechTypes = true;
      };

    });
  };

  $scope.hideTech = function() {
    // HIDE ANY EXISTING SHOWING TECH
    $scope.techSelected = false;
    // CLEAR PROF DROPDOWN
    if(angular.isDefined($scope.profData.repeatSelect)){
    $scope.profData.repeatSelect = null;
    };
  };

  // CREATE NEW TECHNIQUE TYPE
  $scope.newTechType = {};
  $scope.techTypeForm = {};
  $scope.techTypeForm.create = function(){
    var data = {
      name: $scope.newTechType.name,
      position_id: $scope.newTechType.position_id,
      index: ($scope.technique_types.length)

    };

    console.log ($scope.newTechType);

    $http.post(url + '/positions/' + $scope.currentPosition + '/technique_types', data).success(function(response){
      console.log(response);
      $scope.showTechTypes = true;
      $scope.techSelected = false;

      $http.get(url + '/positions/' + $scope.currentPosition + '/technique_types').success(function(response){
      $scope.technique_types = response;
      });
    });
    $scope.newTechType = null;
  };

  // DELETE TECHNIQUE TYPE
  $scope.deleteTechType = function(technique_type){
    var ttype_to_delete = $scope.technique_types.indexOf(technique_type);
    $http.delete(url + '/positions/' + $scope.currentPosition + '/technique_types/' +technique_type.id).success(function(response){
      $scope.technique_types.splice(ttype_to_delete, 1);
      $scope.ttypeSave();
      if ($scope.technique_types.length < 1) {
        $scope.positionBg = false;
        $scope.ttechBg = true;
        $scope.showTechTypes = false;
      };
    });
  console.log(technique_type.id);
  };

// =============== TECHNIQUE =============== //

  // CREATE NEW TECHNIQUE
  $scope.newTech = {};
  $scope.techForm = {};
  $scope.techForm.create = function(technique_type){
    var data = {
      name: $scope.newTech.name,
      technique_type_id: technique_type.id,
      index: technique_type.techniques.length
    };

    console.log($scope.newTech)

    $http.post(url + '/positions/' + $scope.currentPosition + '/technique_types/' +technique_type.id + '/techniques', data).success(function(response){
      console.log(response);

      $http.get(url + '/positions/' + $scope.currentPosition + '/technique_types').success(function(response){
        $scope.technique_types = response;
      });
    });
    $scope.newTech = {};
  };

  // DELETE TECHNIQUE
  $scope.deleteTech = function(){

    $http.delete(url + '/positions/' + $scope.currentPosition + '/technique_types/' + $scope.currentTechnique.technique_type_id + '/techniques/' + $scope.currentTechnique.id).success(function(response){
        $scope.technique_types[tech_type_to_delete].techniques.splice(tech_to_delete, 1);
          $scope.techSelected = false;
        $scope.techniqueSave();
    });
  };

  // =========== TECHNIQUE-COLUMN =========== //

  // SHOW NAME, VIDEO URL, NOTES, STEPS 
  $scope.currentTechnique = [];
  $scope.steps = [];

  // delete variables
  var tech_type_to_delete
  var tech_to_delete

  $scope.getTechnique = function(technique_type, technique){
    console.log(technique.id)

    $scope.proficiencySelect = true;
    var tech_type_to_get = $scope.technique_types.indexOf(technique_type);
    var tech_to_get = $scope.technique_types[tech_type_to_get].techniques.indexOf(technique);

    // Declare delete variables
    tech_type_to_delete = $scope.technique_types.indexOf(technique_type);
    tech_to_delete = $scope.technique_types[tech_type_to_delete].techniques.indexOf(technique);

    console.log('show message is orignally ' + $scope.showMessage)
    $scope.techSelected = true;
    $scope.newStep = null;
    $scope.showVideo = false;
    $scope.showSteps = false;
    $scope.showNotes = false;

    // GET VIDEO URL, NOTES
    $http.get(url + '/positions/' + $scope.currentPosition + '/technique_types/' +technique_type.id + '/techniques/' + technique.id).success(function(response){
      $scope.technique = response;
      $scope.currentTechnique = $scope.technique;
      console.log($scope.currentTechnique);

      // NOTES SHOW
      $scope.newNotes = $scope.currentTechnique.other_notes;
      if ($scope.currentTechnique.other_notes == null) {
        $scope.showNotes = false;
      } else {
        $scope.showNotes = true;
        $scope.showMessage = false;
      }

      // NOTES FILL
      if ($scope.currentTechnique.other_notes == null) {
        $scope.doNotesExist = false;

      } else {
        $scope.doNotesExist = true;
        $scope.showMessage = false;

      };      

      // VIDEO SHOW
      $scope.newVideo = $scope.currentTechnique.video_url;
      if ($scope.currentTechnique.video_url == null) {
        $scope.doVideosExist = false;
        $scope.showVideo = false;

      } else {
        $scope.doVideosExist = true;
        $scope.showVideo = true;
        $scope.showMessage = false;

      };

      // CONVERT VIDEO URL TO EMBEDED

      if ($scope.currentTechnique.video_url != null) {
       $scope.trustSrc = function(src) {
          return $sce.trustAsResourceUrl(src);
        };
        vidURL = $scope.currentTechnique.video_url.split('v=');
        vidID = vidURL[1];
        var ampersandPosition = vidID.indexOf('&');
        if(ampersandPosition != -1) {
          vidID = vidID.substring(0, ampersandPosition);
        };
        $scope.vidSRC = "https://www.youtube.com/embed/" + vidID;
      };
         // $scope.currentProf = $scope.profData.availableOptions[Number($scope.currentTechnique.proficiency) - 1].name || null;

         $scope.resetDropDown();
    });

    // GET STEPS
    $http.get(url + '/positions/' + $scope.currentPosition + '/technique_types/' +technique_type.id + '/techniques/' + technique.id + '/steps').success(function(response) {
        console.log(response);
        $scope.steps = response;
      // STEPS SHOW
      if ($scope.steps.length < 1) {
        $scope.showSteps = false;
        $scope.doStepsExist = false;

      } else {
        $scope.showSteps = true;
        $scope.doStepsExist = true;
        $scope.showMessage = false;

      };

    // CHANGE THE COLOR OF NOTES BOX
    var t = document.getElementById('text');
    if ($scope.doNotesExist == true) {
      t.style.backgroundColor='#fdfdfd';
    } else {
      t.style.backgroundColor='white';
    };


    });


    console.log('show video is now ' + $scope.showVideo)
    console.log('show notes is now ' + $scope.showNotes)
    console.log('steps.length is now ' + $scope.showSteps)
    console.log('=========================')

    console.log('show message is now ' + $scope.showMessage)

    // SHOW MESSAGE?
    if ($scope.showVideo == false && 
        $scope.showNotes == false && 
        $scope.showSteps == false) {
      $scope.showMessage = true;
    } else {
      $scope.showMessage = false;
    };    
  };

  // DELETE VIDEO
  $scope.deleteVideo = function(){
    var data = {
      video_url: null
    };
    $http.put(url + '/positions/' + $scope.currentPosition + '/technique_types/' + $scope.currentTechnique.technique_type_id + '/techniques/' + $scope.currentTechnique.id, data).success(function(response){
      console.log(response);
      $scope.showVideo = false;
      $scope.doVideosExist = false;
      $scope.newVideo = null;
    });
  };

  // DELETE NOTES
  $scope.deleteNotes = function(){
    var data = {
      other_notes: null
    };
    $http.put(url + '/positions/' + $scope.currentPosition + '/technique_types/' + $scope.currentTechnique.technique_type_id + '/techniques/' + $scope.currentTechnique.id, data).success(function(response){
      console.log(response);
      $scope.showNotes = false;
    });
  };


  // EDIT NOTES BUTTON
  $scope.editNotesBtn = function() {
    $scope.doNotesExist = false;
    var t = document.getElementById('text');
    t.style.backgroundColor='white';
  };

  // ADD NOTES BUTTON
  $scope.addNotes = function() {
    $scope.showNotes = true;
    $scope.showMessage = false;
  };

  // ADD STEPS BUTTON 
  $scope.addSteps = function() {
    $scope.showSteps = true;
    $scope.showMessage = false;
  };

  // ADD VIDEO BUTTON
  $scope.addVideo = function() {
    $scope.showVideo = true;
    $scope.showMessage = false;
  };

    // EDIT VIDEO BUTTON
  $scope.editVideoBtn = function() {
    $scope.doVideosExist = false;
  };

  // EDIT NOTES
  $scope.newNotes = {};
  $scope.notesForm = {};

  $scope.notesForm.create = function(){
    var data = {
      other_notes: $scope.newNotes
    };
    $http.put(url + '/positions/' + $scope.currentPosition + '/technique_types/' + $scope.currentTechnique.technique_type_id + '/techniques/' + $scope.currentTechnique.id, data).success(function(response){
      console.log(response)
      $scope.doNotesExist = true;

      var t = document.getElementById('text');
      t.style.backgroundColor='#fdfdfd';
    });
  };

  // EDIT VIDEO_URL
  $scope.newVideo = {};
  $scope.videoForm = {};

  $scope.videoForm.create = function(){
    var data = {
      video_url: $scope.newVideo
    };
  
    $http.put(url + '/positions/' + $scope.currentPosition + '/technique_types/' + $scope.currentTechnique.technique_type_id + '/techniques/' + $scope.currentTechnique.id, data).success(function(response){
      console.log(response);
      $scope.videoResponse = response 

      vidURL = $scope.videoResponse.video_url.split('v=');
      vidID = vidURL[1];
      var ampersandPosition = vidID.indexOf('&');
      if(ampersandPosition != -1) {
        vidID = vidID.substring(0, ampersandPosition);
      };
      $scope.vidSRC = "https://www.youtube.com/embed/" + vidID;
      $scope.doVideosExist = true;

      $http.get(url + '/positions/' + $scope.currentPosition + '/technique_types/' +$scope.currentTechnique.technique_type_id + '/techniques/' + $scope.currentTechnique.id).success(function(response){
        console.log(response);
      });
    });
  };

  // CREATE STEPS
  $scope.newStep = {};
  $scope.stepForm = {};
  $scope.stepForm.create = function(){
    var data = {
      instruction: $scope.newStep
    };
    $http.post(url + '/positions/' + $scope.currentPosition + '/technique_types/' + $scope.currentTechnique.technique_type_id + '/techniques/' + $scope.currentTechnique.id + '/steps', data).success(function(response){
      console.log(response);

      $http.get(url + '/positions/' + $scope.currentPosition + '/technique_types/' + $scope.currentTechnique.technique_type_id + '/techniques/' + $scope.currentTechnique.id + '/steps').success(function(response) {
        console.log(response);
        $scope.steps = response;
      });
    });
    $scope.newStep = null;
  };

    // DELETE STEP
  $scope.deleteStep = function(step){
    var step_to_delete = $scope.steps.indexOf(step);
    $http.delete(url + '/positions/' + $scope.currentPosition + '/technique_types/' + $scope.currentTechnique.technique_type_id + '/techniques/' + $scope.currentTechnique.id + '/steps/' + step.id).success(function(response){
        $scope.steps.splice(step_to_delete, 1);
        if ($scope.steps.length < 1) {
          $scope.showSteps = false;
        };
    });
  };

  // DRAG AND DROP - REORDER INDEX
  $scope.positionSave = function(){
    console.log($scope.positions)
    for(var i = 0; i < $scope.positions.length; i++){
      $scope.positions[i].index = i
      var content = $scope.positions[i];
      $http.put(url + '/positions/' + content.id,content).success(function(response) {
        console.log(response);
      });
    };
  };

  $scope.ttypeSave = function(){
    console.log($scope.technique_types)
    for(var i = 0; i < $scope.technique_types.length; i++){
      $scope.technique_types[i].index = i
      var content = $scope.technique_types[i];
      $http.put(url + '/positions/' + $scope.currentPosition + '/technique_types/' + content.id,content).success(function(response) {
        console.log(response);
      });
    };
  };

  $scope.techniqueSave = function(){
    console.log($scope.technique_types)
    for (var x = 0; x < $scope.technique_types.length; x++){
      for(var i = 0; i < $scope.technique_types[x].techniques.length; i++){
        $scope.technique_types[x].techniques[i].index = i;
        var content = $scope.technique_types[x].techniques[i];
        $http.put(url + '/positions/' + $scope.currentPosition + '/technique_types/' + $scope.currentTechnique.technique_type_id + '/techniques/' + content.id, content).success(function(response){
          console.log(response);
        });
      };
    };
  };

  // PROFECIENCY
  $scope.profData = {
    repeatSelect: null,
    availableOptions: [
      {id: '1', name: 'Very good'},
      {id: '2', name: 'Needs practice'},
      {id: '3', name: 'To be learned'}
    ],
   };

  $scope.setProf = function(item) {
    var data = {
      proficiency: item
    };  
    $http.put(url + '/positions/' + $scope.currentPosition + '/technique_types/' + $scope.currentTechnique.technique_type_id + '/techniques/' + $scope.currentTechnique.id, data).success(function(response){
      $scope.getPosition($scope.currentPositionFull)  
      $scope.currentTechnique.proficiency = response.proficiency
      console.log(response)
        $scope.proficiencySelect = true;
    });
  };

  $scope.resetDropDown = function() {
    if(angular.isDefined($scope.profData.repeatSelect)){
      $scope.profData.repeatSelect = $scope.currentTechnique.proficiency;
    };
  };

}]);
